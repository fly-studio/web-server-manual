#  # supervisor
## ## 安装
```
# 如果没有 easy_install 需要安装 python-setuptools
$ yum install python-setuptools
$ easy_install supervisor
```
## ## 配置
```
# 设置默认配置
$ echo_supervisord_conf > /etc/supervisord.conf
$ vim /etc/supervisord.conf
```
将此项加入到结尾
```
[include]
files = /www/supervisor/*.conf
```

### Laravel队列示例
/www/supervisor/laravel.conf
```
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /www/website/base/artisan queue:work --queue=default,wechat --sleep=3 --tries=3 --timeout=110 --daemon
autostart=true
autorestart=true
user=nobody
numprocs=5
redirect_stderr=true
stdout_logfile=/www/website/base/worker.log
```

> --timeout 应该永远都要比 ```config/queue.php```- ```retry_after``` 短至少几秒钟的时间。这样就能保证任务进程总能在失败重试前就被杀死了。如果你的 --timeout 选项大于 retry_after 配置选项，你的任务可能被执行两次

## ## 操作
### 设置服务脚本
#### CentOS 6
```
$ vim /etc/init.d/supervisord
```
写入如下内容
```
#! /bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin:
PROGNAME=supervisord
DAEMON=/usr/bin/$PROGNAME
CONFIG=/etc/$PROGNAME.conf
PIDFILE=/tmp/$PROGNAME.pid
DESC="supervisord daemon"
SCRIPTNAME=/etc/init.d/$PROGNAME
# Gracefully exit if the package has been removed.
test -x $DAEMON || echo "$DAEMON is not exists" || exit 0

start()
{
        echo -n "Starting $DESC: $PROGNAME"
        $DAEMON -c $CONFIG
        echo "..."
}
stop()
{
        echo -n "Stopping $DESC: $PROGNAME"
        supervisor_pid=$(cat $PIDFILE)
        kill -15 $supervisor_pid
        echo "..."
}
case "$1" in
  start)
        start
        ;;
  stop)
        stop
        ;;
  restart)
        stop
        start
        ;;
  *)
        echo "Usage: $SCRIPTNAME {start|stop|restart}" >&2
        exit 1
        ;;
esac
exit 0

```

> 或者参考下面的文本
https://github.com/cedricporter/supervisor_conf/blob/master/init.d/supervisor
> 需要修改 DAEMON SUPERVISORCTL 的路径
> 以及安装 start-stop-daemon

设置执行权限
```
$ chmod +x /etc/init.d/supervisord
```

#### CentOS 7
```
vim /usr/lib/systemd/system/supervisord.service
```
```
# supervisord service for sysstemd (CentOS 7.0+)
# by ET-CS (https://github.com/ET-CS)
[Unit]
Description=Supervisor daemon

[Service]
Type=forking
ExecStart=/usr/bin/supervisord -c /etc/supervisord.conf
ExecStop=/usr/bin/supervisorctl $OPTIONS shutdown
ExecReload=/usr/bin/supervisorctl $OPTIONS reload
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
```
### 注册服务
```
$ chkconfig supervisord on
# 7.0
$ systemctl enable supervisord.service
```
### 启动
```
$ service supervisord start
# 7.0
$ systemctl start supervisord.service
```
### 停止
```
$ service supervisord stop
# 7.0
$ systemctl stop supervisord.service
```
### 重启
```
$ service supervisord restart
# 7.0
$ systemctl restart supervisord.service
```
### 查询状态
```
$ supervisorctl status
```
### 动态读取配置
如果添加了conf文件，可以使用以下命令启动
```
$ supervisorctl reread
$ supervisorctl update
```
针对指定任务，启动、重启
```
$ supervisorctl start laravel-worker
$ supervisorctl restart laravel-worker
```

# # Aria2
## ## 安装
官网 http://aria2.sourceforge.net/ 不过源代码在CentOS下无法编译通过
```
$ yum --enablerepo=rpmforge install aria2
```
## ## 配置
将下面的内容保存到/etc/aria2.conf
> 可以查看解释 http://my.oschina.net/pureboys/blog/342233

```
#用户名
#rpc-user=user
#密码
#rpc-passwd=passwd
#上面的认证方式不建议使用,建议使用下面的token方式
#设置加密的密钥
#rpc-secret=token
#允许rpc
enable-rpc=true
#允许所有来源, web界面跨域权限需要
rpc-allow-origin-all=true
#允许外部访问，false的话只监听本地端口
rpc-listen-all=true
#RPC端口, 仅当默认端口被占用时修改
#rpc-listen-port=6800
#最大同时下载数(任务数), 路由建议值: 3
max-concurrent-downloads=5
#断点续传
continue=true
#同服务器连接数
max-connection-per-server=5
#最小文件分片大小, 下载线程数上限取决于能分出多少片, 对于小文件重要
min-split-size=10M
#单文件最大线程数, 路由建议值: 5
split=10
#下载速度限制
max-overall-download-limit=0
#单文件速度限制
max-download-limit=0
#上传速度限制
max-overall-upload-limit=0
#单文件速度限制
max-upload-limit=0
#断开速度过慢的连接
#lowest-speed-limit=0
#验证用，需要1.16.1之后的release版本
#referer=*
#文件保存路径, 默认为当前启动位置
dir=/www/website
#文件缓存, 使用内置的文件缓存, 如果你不相信Linux内核文件缓存和磁盘内置缓存时使用, 需要1.16及以上版本
#disk-cache=0
#另一种Linux文件缓存方式, 使用前确保您使用的内核支持此选项, 需要1.15及以上版本(?)
#enable-mmap=true
#文件预分配, 能有效降低文件碎片, 提高磁盘性能. 缺点是预分配时间较长
#所需时间 none < falloc ? trunc << prealloc, falloc和trunc需要文件系统和内核支持
file-allocation=prealloc
#关闭ipv6
disable-ipv6=true
#记录保持地址
input-file=/www/website/aria2.session
save-session=/www/website/aria2.session
#定时保存会话，需要1.16.1之后的release版
save-session-interval=60
```
## ## 后台启动
通过这种方式后台启用，然后使用web来管理本软件
```
$ aria2c --conf-path=/etc/aria2.conf -D
```
## ## 管理界面 YAAW
官网 http://binux.github.io/yaaw/
这是一个Web的管理界面
```
$ cd /www/website/
$ wget https://github.com/binux/yaaw/tarball/master -O "yaaw.tar.gz"
$ tar zxvf yaaw.tar.gz
$ mv binux-yaaw-* yaaw
```
现在可以访问 http://.../yaaw 来管理下载任务了

# # git
安装最新版本的git-core
## ## yum 安装
```
$ yum install http://opensource.wandisco.com/centos/6/git/x86_64/wandisco-git-release-6-1.noarch.rpm
```
```
$ yum install git
```
## ## 源代码编译
依赖安装
```
$ yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel
$ yum install  gcc perl-ExtUtils-MakeMaker
```
卸载旧版本
```
yum remove git
```
下载/编译
```
# 下载解压
$ cd /usr/src
$ wget https://www.kernel.org/pub/software/scm/git/git-2.10.1.tar.gz
$ tar -zxvf git-2.10.1.tar.gz

# 编译
$ cd git-2.10.1
$ make prefix=/usr/local/git all
$ make prefix=/usr/local/git install
#
$ echo 'export PATH=$PATH:/usr/local/git/bin' >> /etc/bashrc
#  or
$ echo 'export PATH=$PATH:/usr/local/git/bin' > /etc/profile.d/git.sh
#
$ source /etc/bashrc
```
> Updated method of adding compiled git bin directory to bashrc. Because echo "export PATH=$PATH:/usr/local/git/bin" >> /etc/bashrc used "" instead of '', it would expand the current session's value for $PATH instead of keeping it as a variable, and could adversely affect the entire system. At the minimum, it should use '' instead of "" and should really be a separate script in /etc/profile.d/

## ## 查看版本
```
$ git --version
```

# # Ruby
## ## RVM Ruby Virtual Manage
必要依赖
```
$ yum install gcc-c++ patch readline readline-devel zlib zlib-devel
$ yum install libyaml-devel libffi-devel openssl-devel make
$ yum install bzip2 autoconf automake libtool bison iconv-devel sqlite-devel
```
rvm
```
$ curl -sSL https://get.rvm.io | bash -s stable
```
刷新系统环境变量
```
$ source /etc/profile.d/rvm.sh
```
安装ruby
```
$ rvm install 2.3.1
```
选择默认版本
```
$ rvm use 2.3.1 --default
```

## ## 编译安装
卸载旧版本
```
$ rpm -e --nodeps ruby
```
安装
```
$ wget https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.1.tar.gz
$ tar zxvf ruby-2.3.1.tar.gz
$ cd ruby-2.3.1
$ ./configure
$ make
$ sudo make install
```
刷新环境变量
```
$ source /etc/profile
```

# # Go
## ## yum 安装
天地良心，epel库里golang是最新版
```
yum install go
```

## ## 编译安装
```
$ wget https://storage.googleapis.com/golang/go1.7.1.linux-amd64.tar.gz
$ tar -C /usr/local -xzf go1.7.1.linux-amd64.tar.gz
$ ln -sf /usr/local/go/bin/{go,godoc,gofmt} /usr/local/bin/
```
