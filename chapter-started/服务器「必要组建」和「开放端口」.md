# 编译类软件
## ## autoconf
> 自行选择升级

```
$ wget ftp://ftp.gnu.org/gnu/autoconf/autoconf-2.69.tar.gz
$ tar -zxvf autoconf*.tar.gz
$ cd autoconf-*
$ ./configure --prefix=/usr/
$ make && make install
```
查看版本
```
$ autoconf -V
```
## ## GCC
> 自行选择升级

### 安装GCC

> CentOS中默认的gcc版本为： 
> gcc (GCC) 4.4.7 20120313 (Red Hat 4.4.7-17)

#### - 4.8
安装源
```
$ wget http://people.centos.org/tru/devtools-2/devtools-2.repo -O /etc/yum.repos.d/devtools-2.repo
```
安装
```
$ yum install devtoolset-2-binutils devtoolset-2-gcc devtoolset-2-gcc-c++

# 备份之前的gcc 或者自行手动备份
$ mv /usr/bin/gcc /usr/bin/gcc-v4.4.7
$ mv /usr/bin/g++ /usr/bin/g++-v4.4.7
$ mv /usr/bin/cc /usr/bin/cc-v4.4.7

$ ln -fs /opt/rh/devtoolset-2/root/usr/bin/gcc /usr/bin/gcc
$ ln -fs /opt/rh/devtoolset-2/root/usr/bin/gcc /usr/bin/cc
$ ln -fs /opt/rh/devtoolset-2/root/usr/bin/g++ /usr/bin/g++
```
#### - 4.9
安装源

如果下面面的包不存在，请安装[Sclo-RH源](/chapter-started/repo-仓库.md)
```
$ yum install centos-release-scl-rh
```
安装
```
$ yum install devtoolset-3-binutils devtoolset-3-gcc devtoolset-3-gcc-c++

# 如果是全新安装，备份之前的gcc
$ mv /usr/bin/gcc /usr/bin/gcc-v4.4.7
$ mv /usr/bin/g++ /usr/bin/g++-v4.4.7
$ mv /usr/bin/cc /usr/bin/cc-v4.4.7

$ ln -fs /opt/rh/devtoolset-3/root/usr/bin/gcc /usr/bin/gcc
$ ln -fs /opt/rh/devtoolset-3/root/usr/bin/gcc /usr/bin/cc
$ ln -fs /opt/rh/devtoolset-3/root/usr/bin/g++ /usr/bin/g++
```

### 安装其他编译软件
```
$ yum install gcc gcc-c++ clang autoconf automake
```

## ## GLIBC
> 自行选择升级，MySQL 需要glibc 2.17 +

分别运行下面的两个命令可以查看系统的版本
```
$ rpm -qa | grep glibc
$ strings /lib64/libc.so.6 | grep GLIBC
```
下载
```
$ wget http://ftp.gnu.org/gnu/glibc/glibc-2.25.tar.gz
$ tar -zxvf glibc*.tar.gz
$ cd glibc*
$ mkdir build
$ cd build
$ ../configure --prefix=/usr/local/glibc
$ make -j4 & make install
```
设置
```
$ rm -rf /lib64/libc.so.6
$ ln -s /usr/local/glibc/lib/libc-2.24.so /lib64/libc.so.6
$ export LD_LIBRARY_PATH=/usr/local/glibc/lib:${LD_LIBRARY_PATH} 
```
删除之后应该访问不了系统命令
```
$ LD_PRELOAD=/usr/local/glibc/lib/libc-2.24.so  ln -s /usr/local/glibc/lib/libc-2.24.so /lib64/libc.so.6
```
还是访问不了，就用还原了
```
$ LD_PRELOAD=/lib64/libc-2.12.so  ln -s /lib64/libc-2.12.so /lib64/libc.so.6
$ unset LD_LIBRARY_PATH
```

# 常用组件
## ## openSSL 1.1.0
如果条件不允许，请参照下文openSSL 1.0.2

1.1.0c [下载地址](https://www.openssl.org/source/openssl-1.1.0-latest.tar.gz "下载地址")
```
$ wget https://www.openssl.org/source/openssl-1.1.0-latest.tar.gz
$ tar -zxf openssl-*-latest.tar.gz
$ cd openssl-*
# 安装
$ ./config
$ make
$ make test
$ make install
$ mv /usr/bin/openssl /usr/bin/openssl-v1.0.1
$ ln -s /usr/local/lib64/libssl.so.1.1 /usr/lib64/libssl.so.1.1
$ ln -s /usr/local/lib64/libcrypto.so.1.1 /usr/lib64/libcrypto.so.1.1
$ ln -s /usr/local/bin/openssl /usr/bin/openssl
```
## ## openSSL 1.0.2
一般情况下，安装 1.1.0 即可

- 1.0.2需要打ChaCha20/Poly1305的补丁，这两个加密算法对手机支持友好 [cloudflare补丁](https://github.com/travislee8964/sslconfig/tree/master/patches "cloudflare补丁")
- 由于默认 gcc 版本为 4.4.7，在添加 Chacha 20 补丁之后，编译会报错：[#11](https://github.com/cloudflare/sslconfig/issues/11 "#11")，需要将 gcc 升级到 4.8 以上版本：

```
$ wget https://www.openssl.org/source/openssl-1.0.2-latest.tar.gz
$ tar -zxf openssl-*-latest.tar.gz
$ cd openssl-*
# openssl-1.0.2j 打补丁
$ wget https://raw.githubusercontent.com/travislee8964/sslconfig/master/patches/openssl__chacha20_poly1305_draft_and_rfc_ossl102i.patch
$ patch -p1 < ./openssl__chacha20_poly1305_draft_and_rfc_ossl102i.patch
# 安装
$ ./config
$ make
$ make test
$ make install
$ mv /usr/bin/openssl /usr/bin/openssl-v1.0.1
$ ln -s /usr/local/lib64/libssl.so.1.1 /usr/lib64/libssl.so.1.1
$ ln -s /usr/local/lib64/libcrypto.so.1.1 /usr/lib64/libcrypto.so.1.1
$ ln -s /usr/local/bin/openssl /usr/bin/openssl
```



# iptables的端口控制(非必须)
比如服务器关闭iptables，则无需配置下列项

## 开放必要端口
```
# 开放22(SSH)、80(Web)、3360（MySQL）、11211(Memcache)
$ iptables -A INPUT -p tcp -m multiport --port 22,80,3360,11211
# 开放本地回路
$ iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT
# 保存并重启iptables
$ service iptables save
$ service iptables restart
```

## 进阶：建立一个只开放22、80端口的iptables
```
# 取消其他端口的访问规则
$ iptables -P INPUT DROP
$ iptables -P FORWARD DROP
$ iptables -P OUTPUT DROP
# 开放22、80
$ iptables -A INPUT -p tcp --dport 22 -j ACCEPT
$ iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT
$ iptables -A INPUT -p tcp --dport 80 -j ACCEPT
$ iptables -A OUTPUT -p tcp --sport 80 -j ACCEPT
$ iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # 允许已建立的或相关连的通行
$ iptables -A OUTPUT -j ACCEPT # 允许所有本机向外的访问
# 保存并重启iptables
$ service iptables save
$ service iptables restart
```

# # CentOS 7.0 firewall 端口控制
> https://access.redhat.com/documentation/zh-CN/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html

## ## 安装firewall
```
$ yum install firewalld firewall-config
```
## ## 操作
启动：
```
$ systemctl start firewalld
```
查看状态：
```
$ systemctl status firewalld 或者 firewall-cmd --state
```
停止：
```
$ systemctl disable firewalld
```
禁用：
```
$ systemctl stop firewalld
```
查看版本
```
$ firewall-cmd --version
```
查看所有版本
```
$ firewall-cmd --list-all
```

## ## Zone的概念

#### drop（丢弃）
任何接收的网络数据包都被丢弃，没有任何回复。仅能有发送出去的网络连接。
#### block（限制）
任何接收的网络连接都被 IPv4 的 icmp-host-prohibited 信息和 IPv6 的 icmp6-adm-prohibited 信息所拒绝。
#### public（公共） 默认的
在公共区域内使用，不能相信网络内的其他计算机不会对您的计算机造成危害，只能接收经过选取的连接。
#### external（外部）
特别是为路由器启用了伪装功能的外部网。您不能信任来自网络的其他计算，不能相信它们不会对您的计算机造成危害，只能接收经过选择的连接。
#### dmz（非军事区）
用于您的非军事区内的电脑，此区域内可公开访问，可以有限地进入您的内部网络，仅仅接收经过选择的连接。
#### work（工作）
用于工作区。您可以基本相信网络内的其他电脑不会危害您的电脑。仅仅接收经过选择的连接。
#### home（家庭）
用于家庭网络。您可以基本信任网络内的其他计算机不会危害您的计算机。仅仅接收经过选择的连接。
#### internal（内部）
用于内部网络。您可以基本上信任网络内的其他计算机不会威胁您的计算机。仅仅接受经过选择的连接。
#### trusted（信任）
可接受所有的网络连接。

## ## 操作Zone

查看正在活动的区域: 
```
$ firewall-cmd --get-active-zones
```
获取默认区域
```
$ firewall-cmd --get-default-zone
```
设置默认接口区域(无需重启立即生效)
```
$ firewall-cmd --set-default-zone=public
```
查看指定接口所属区域：
```
$ firewall-cmd --get-zone-of-interface=eth0
```
将接口添加到区域(默认接口都在public)
```
# 临时
$ firewall-cmd --zone=public --add-interface=eth0
# 永久
$ firewall-cmd --zone=public --add-interface=eth0 --permanent
```
移除接口
```
$ firewall-cmd --remove-interface=eth0
```
## ##　操作端口
查看dmz所有打开的端口：
```
$ firewall-cmd --zone=dmz --list-ports
```
加入一个端口到dmz区域：
```
# 临时
$ firewall-cmd --zone=dmz --add-port=8080/tcp
# 永久
$ firewall-cmd --zone=dmz --add-port=8080/tcp --permanent
# 查询该端口是否成功
$ firewall-cmd --zone=dmz --query-port=8080/tcp
```
## ## 操作服务
> /etc/firewalld 目录下有services文件夹

```
$ firewall-cmd --zone=work --add-service=smtp
# 移除服务
$ firewall-cmd --zone=work --remove-service=smtp
```

## ## 更新防火墙规则：
> 两者的区别就是第一个无需断开连接，就是firewalld特性之一动态添加规则，第二个需要断开连接，类似重启服务

```
$ firewall-cmd --reload
$ firewall-cmd --complete-reload
```

## ## 拒绝
拒绝所有包：
```
$ firewall-cmd --panic-on
```
取消拒绝状态：
```
$ firewall-cmd --panic-off
```
查看是否拒绝：
```
$ firewall-cmd --query-panic
```

## ## 开放80端口HTTP服务
```
$ firewall-cmd --zone=public --add-port=80/tcp --permanent
$ firewall-cmd --zone=public --add-service=http --permanent
```
查询是否正常
```
$ firewall-cmd --zone=public --list-ports
$ firewall-cmd --zone=public --list-services
```